generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  name          String?
  password      String
  role          Role     @default(EDITOR)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  assignedLeads Lead[]   @relation("LeadAssignedTo")
}

model Market {
  id                String    @id @default(uuid())
  code              String    @unique
  labelPt           String
  labelEn           String
  heroMessagePt     String?
  heroMessageEn     String?
  priority          Int       @default(0)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  heroMessageEs     String?
  heroMessageFr     String?
  labelEs           String?
  labelFr           String?
  highlightProjects Project[]
}

model Media {
  id               String          @id @default(uuid())
  type             MediaType       @default(IMAGE)
  originalUrl      String
  thumbnailUrl     String?
  mediumUrl        String?
  largeUrl         String?
  webpUrl          String?
  avifUrl          String?
  width            Int?
  height           Int?
  sizeBytes        Int?
  durationSeconds  Int?
  format           String?
  contentType      String?
  altPt            String?
  altEn            String?
  altEs            String?
  altFr            String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  projectHero      Project?
  projectGalleries ProjectMedia[]
  pageHeroBackgrounds Page[]       @relation("PageHeroBackground")
  pageDemoreelVideos  Page[]       @relation("PageDemoreelVideo")
  analysis         MediaAnalysis?
}

model Tag {
  id        String      @id @default(uuid())
  slug      String      @unique
  labelPt   String
  labelEn   String
  labelEs   String?
  labelFr   String?
  category  TagCategory
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  projects  Project[]   @relation("ProjectToTag")
}

model Service {
  id            String        @id @default(uuid())
  slug          String        @unique
  titlePt       String
  titleEn       String
  titleEs       String?
  titleFr       String?
  descriptionPt String?
  descriptionEn String?
  descriptionEs String?
  descriptionFr String?
  icon          String?
  status        ServiceStatus @default(PUBLISHED)
  priority      Int           @default(0)
  segments      String[]
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  projects      Project[]     @relation("ProjectToService")
}

model Project {
  id            String               @id @default(uuid())
  slug          String               @unique
  title         String
  shortTitle    String?
  summaryPt     String?
  summaryEn     String?
  summaryEs     String?
  summaryFr     String?
  city          String?
  stateProvince String?
  country       String?
  year          Int?
  client        String?
  type          String?
  featured      Boolean              @default(false)
  priorityHome  Int                  @default(0)
  status        ProjectStatus        @default(DRAFT)
  ctaLabelPt    String?
  ctaLabelEn    String?
  ctaUrl        String?
  heroImageId   String?              @unique
  marketId      String?
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt
  descriptionEn String?
  descriptionEs String?
  descriptionFr String?
  descriptionPt String?
  pageViews     PageView[]
  heroImage     Media?               @relation(fields: [heroImageId], references: [id])
  market        Market?              @relation(fields: [marketId], references: [id])
  interactions  ProjectInteraction[]
  gallery       ProjectMedia[]
  services      Service[]            @relation("ProjectToService")
  tags          Tag[]                @relation("ProjectToTag")
  sections      Section[]            @relation("SectionProjects")
}

model Page {
  id                     String     @id @default(uuid())
  name                   String
  slug                   String     @unique
  seoTitlePt             String?
  seoTitleEn             String?
  seoDescPt              String?
  seoDescEn              String?
  status                 PageStatus @default(PUBLISHED)
  createdAt              DateTime   @default(now())
  updatedAt              DateTime   @updatedAt
  heroSloganPt           String?
  heroSloganEn           String?
  heroSloganEs           String?
  heroSloganFr           String?
  heroSubtitleEn         String?
  heroSubtitleEs         String?
  heroSubtitleFr         String?
  heroSubtitlePt         String?
  seoDescEs              String?
  seoDescFr              String?
  seoTitleEs             String?
  seoTitleFr             String?
  pillar1Pt              String?
  pillar1En              String?
  pillar1Es              String?
  pillar1Fr              String?
  pillar2Pt              String?
  pillar2En              String?
  pillar2Es              String?
  pillar2Fr              String?
  pillar3Pt              String?
  pillar3En              String?
  pillar3Es              String?
  pillar3Fr              String?
  // Hero Media - Sistema Híbrido (Media OU URL manual)
  heroBackgroundImageId  String?
  heroBackgroundImageUrl String?
  demoreelVideoId        String?
  demoreelVideoUrl       String?
  heroBackgroundImage    Media?     @relation("PageHeroBackground", fields: [heroBackgroundImageId], references: [id])
  demoreelVideo          Media?     @relation("PageDemoreelVideo", fields: [demoreelVideoId], references: [id])
  sections               Section[]
}

model Section {
  id             String    @id @default(uuid())
  pageId         String
  order          Int       @default(0)
  type           String
  layout         String?
  titlePt        String?
  titleEn        String?
  titleEs        String?
  titleFr        String?
  bodyPt         String?
  bodyEn         String?
  bodyEs         String?
  bodyFr         String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  page           Page      @relation(fields: [pageId], references: [id])
  linkedProjects Project[] @relation("SectionProjects")
}

model ProjectMedia {
  id        String   @id @default(uuid())
  projectId String
  mediaId   String
  order     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  media     Media    @relation(fields: [mediaId], references: [id], onDelete: Cascade)
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, mediaId])
  @@index([projectId, order])
}

model VisitorSession {
  sessionId           String               @id
  ipAddress           String?
  userAgent           String?
  language            String?
  country             String?
  region              String?
  city                String?
  duration            Int                  @default(0)
  lastActivityAt      DateTime             @default(now())
  leadId              String?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  
  // NOVOS CAMPOS PARA ANALYTICS AVANÇADO
  visitorFingerprint  String?              @unique // Hash único do visitante (identifica anônimo)
  deviceType          String?              // mobile, desktop, tablet
  browser             String?              // Chrome, Safari, Firefox, etc
  os                  String?              // Windows, macOS, iOS, Android
  screenResolution    String?              // 1920x1080
  referrer            String?              // De onde veio
  utmSource           String?              // utm_source da URL
  utmMedium           String?              // utm_medium
  utmCampaign         String?              // utm_campaign
  visitCount          Int                  @default(1) // Quantas vezes voltou
  isReturning         Boolean              @default(false) // Visitante frequente
  isPWAInstalled      Boolean              @default(false) // Instalou PWA
  bounceRate          Boolean              @default(false) // Só entrou e saiu (sem interação)
  engagementScore     Int                  @default(0) // 0-100 (baseado em interações)
  conversionProbability Float?             // Probabilidade de converter (0-1, calculado por IA)
  
  interestScore       InterestScore?
  pageViews           PageView[]
  projectInteractions ProjectInteraction[]
  pwaInstalls         PWAInstall[]
  visitorBehaviors    VisitorBehavior[]
  lead                Lead?                @relation(fields: [leadId], references: [id], onDelete: SetNull)
  
  @@index([visitorFingerprint])
  @@index([country])
  @@index([isReturning])
  @@index([isPWAInstalled])
  @@index([createdAt])
  @@index([lastActivityAt])
}

model PageView {
  id          String         @id @default(uuid())
  sessionId   String
  pageSlug    String?
  projectSlug String?
  projectId   String?
  timeSpent   Int            @default(0)
  scrollDepth Int            @default(0)
  viewedAt    DateTime       @default(now())
  project     Project?       @relation(fields: [projectId], references: [id])
  session     VisitorSession @relation(fields: [sessionId], references: [sessionId])
}

model ProjectInteraction {
  id        String                 @id @default(uuid())
  sessionId String
  projectId String
  type      ProjectInteractionType @default(VIEW)
  metadata  Json
  createdAt DateTime               @default(now())
  project   Project                @relation(fields: [projectId], references: [id])
  session   VisitorSession         @relation(fields: [sessionId], references: [sessionId])
}

model InterestScore {
  sessionId           String         @id
  museumScore         Int            @default(0)
  brandScore          Int            @default(0)
  festivalScore       Int            @default(0)
  cityScore           Int            @default(0)
  educationScore      Int            @default(0)
  researchScore       Int            @default(0)
  vrScore             Int            @default(0)
  aiScore             Int            @default(0)
  installationScore   Int            @default(0)
  conversionScore     Int            @default(0)
  visitorType         String?
  recommendedProjects Json?
  suggestedAction     String?
  suggestedPage       String?
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt
  session             VisitorSession @relation(fields: [sessionId], references: [sessionId])
}

model Lead {
  id            String           @id @default(uuid())
  name          String
  email         String
  phone         String?
  company       String?
  position      String?
  leadType      LeadType         @default(CONTACT_FORM)
  projectType   String?
  budget        String?
  timeline      String?
  description   String?
  sourceUrl     String?
  referrer      String?
  utmSource     String?
  utmMedium     String?
  utmCampaign   String?
  status        LeadStatus       @default(NEW)
  priority      LeadPriority     @default(MEDIUM)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  assignedToId  String?
  assignedAt    DateTime?
  notes         String?
  lastContactAt DateTime?
  // NOVOS CAMPOS PARA ANALYTICS
  leadScore     Int              @default(0) // 0-100
  organizationType String?        // governo, museu, corporativo, etc
  estimatedValue Float?           // R$
  interestInGrants Boolean        @default(false)
  country       String?
  city          String?
  
  // CAMPOS VANCOUVER (Estudar em Vancouver)
  age                  Int?
  currentSituation     String?
  targetSchool         String?         // VFS, VanArts, etc
  areaInterest         String?         // 3D Animation, Game Design, etc
  intakeYear           String?         // 2026, 2027, 2028
  englishLevel         String?         // Iniciante, Intermediário, Avançado, Fluente
  hasPortfolio         String?         // sim-completo, sim-precisa-melhorar, comecando, nao-tenho
  budgetRange          String?         // ate-100k, 100k-200k, etc
  fundingSource        String?         // familia, economia-propria, financiamento, bolsa
  howHeard             String?         // webinar, palestra-escola, feira, redes-sociais, indicacao, google
  comments             String?
  
  assignedTo    User?            @relation("LeadAssignedTo", fields: [assignedToId], references: [id])
  editalLeads   LeadEdital[]
  sessions      VisitorSession[]

  @@index([status])
  @@index([priority])
  @@index([assignedToId])
  @@index([createdAt])
  @@index([leadScore])
  @@index([email])
}

model Edital {
  id                  String       @id @default(uuid())
  name                String
  source              String
  sourceUrl           String
  country             String
  type                EditalType
  area                String
  categories          String[]
  minValue            Float?
  maxValue            Float?
  currency            String       @default("BRL")
  deadline            DateTime?
  applicationDeadline DateTime?
  status              EditalStatus @default(ABERTO)
  eligibility         String?
  applicationSteps    String?
  requiredDocs        String[]
  description         String?
  requirements        String?
  relevanceScore      Int          @default(0)
  matchedServices     String[]
  matchedProjects     String[]
  azimutFitNotes      String?
  contactEmail        String?
  contactName         String?
  contactPhone        String?
  contactLinkedIn     String?
  scrapedAt           DateTime     @default(now())
  lastChecked         DateTime?
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
  leads               LeadEdital[]

  @@index([status])
  @@index([deadline])
  @@index([country])
  @@index([relevanceScore])
  @@index([source])
}

model LeadEdital {
  id              String           @id @default(uuid())
  editalId        String
  leadId          String
  emailSent       Boolean          @default(false)
  emailSentAt     DateTime?
  callScheduled   Boolean          @default(false)
  callScheduledAt DateTime?
  callLink        String?
  portfolioSent   Boolean          @default(false)
  portfolioSentAt DateTime?
  proposalSent    Boolean          @default(false)
  proposalSentAt  DateTime?
  status          LeadEditalStatus @default(PENDING)
  notes           String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  edital          Edital           @relation(fields: [editalId], references: [id], onDelete: Cascade)
  lead            Lead             @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@unique([editalId, leadId])
  @@index([status])
}

model Settings {
  id                     String   @id @default("singleton")
  siteName               String?  @default("Azimut")
  siteUrl                String?  @default("https://azmt.com.br")
  contactEmail           String?
  contactPhone           String?
  defaultMetaDescription String?
  defaultKeywords        String?
  ogImageUrl             String?
  facebookUrl            String?
  instagramUrl           String?
  linkedinUrl            String?
  twitterUrl             String?
  youtubeUrl             String?
  kabbamApiKey           String?
  kabbamApiUrl           String?
  smtpHost               String?
  smtpPort               Int?
  smtpUser               String?
  smtpPassword           String?
  smtpFromEmail          String?
  deepseekApiKey         String?
  notificationEmail      String?
  defaultLanguage        String?  @default("pt")
  defaultCountry         String?  @default("BR")
  timezone               String?  @default("America/Sao_Paulo")
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
}

enum Role {
  SUPER_ADMIN
  ADMIN
  EDITOR
  VIEWER
}

enum TagCategory {
  TECHNOLOGY
  INDUSTRY
  FORMAT
  OTHER
}

enum ServiceStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum ProjectStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum PageStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum LeadType {
  CONTACT_FORM
  BUDGET_INQUIRY
  VANCOUVER
}

enum LeadPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum LeadStatus {
  NEW
  IN_PROGRESS
  WON
  LOST
  CONTACTED
  PROPOSAL_SENT
  NEGOTIATION
}

enum EditalType {
  FEDERAL
  ESTADUAL
  MUNICIPAL
  PRIVADO
  ONG
  INSTITUTO
  PROVINCIAL
  NATIONAL
}

enum EditalStatus {
  ABERTO
  FECHADO
  ENVIADO
  GANHO
  PERDIDO
}

enum LeadEditalStatus {
  PENDING
  CONTACTED
  EMAIL_SENT
  CALL_SCHEDULED
  PROPOSAL_SENT
  WON
  LOST
}

enum MediaType {
  IMAGE
  VIDEO
}

enum ProjectInteractionType {
  VIEW
  CLICK
  LIKE
  SHARE
  CTA
}

// ════════════════════════════════════════════════════════════
// QUIZ VANCOUVER & COURSE RECOMMENDER - IA RESPONSES
// ════════════════════════════════════════════════════════════

model QuizVancouverResponse {
  id                String   @id @default(uuid())
  sessionId         String?  // Se anônimo (antes do lead)
  leadId            String?  // Se já preencheu formulário
  
  // Respostas do Quiz (10 perguntas)
  experience        String   // zero, beginner, intermediate, advanced
  english           String   // basic, intermediate, advanced, native
  goal              String   // career-change, skill-up, portfolio, immigration
  area              String   // animation, vfx, game, film
  budget            String   // low, medium, high, very-high
  timeline          String   // asap, soon, planning, researching
  portfolio         String   // none, basic, good, professional
  software          String   // none, basic, intermediate, advanced
  commitment        String   // exploring, serious, decided, ready
  support           String   // self, partial, full, sponsored
  
  // Resultado calculado
  score             Int      // 0-100
  readiness         String   // low, medium, high
  bestSchool        String   // VFS, VanArts
  estimatedBudget   String   // CAD 25k-30k, etc
  
  // Metadata
  lang              String   @default("pt")
  completedAt       DateTime @default(now())
  createdAt         DateTime @default(now())
  
  @@index([sessionId])
  @@index([leadId])
  @@index([score])
  @@index([readiness])
  @@index([completedAt])
}

model CourseRecommendationResponse {
  id                String   @id @default(uuid())
  sessionId         String?  // Se anônimo (antes do lead)
  leadId            String?  // Se já preencheu formulário
  
  // Respostas do Recomendador (5 perguntas)
  experience        String   // zero, beginner, intermediate, advanced
  goal              String   // job, freelance, career-change, level-up
  time              String   // part-time, weekends, full-time
  budget            String   // low, medium, high
  interest          String   // ai, creative, technical, immersive
  
  // Cursos recomendados (Top 3)
  course1Id         String
  course1Match      Int      // % match
  course2Id         String
  course2Match      Int
  course3Id         String
  course3Match      Int
  
  // Metadata
  lang              String   @default("pt")
  completedAt       DateTime @default(now())
  createdAt         DateTime @default(now())
  
  @@index([sessionId])
  @@index([leadId])
  @@index([completedAt])
}

// ════════════════════════════════════════════════════════════
// VIDEOS VFS/VANARTS
// ════════════════════════════════════════════════════════════

model AcademyVideo {
  id              String          @id @default(uuid())
  
  // Video Info
  videoUrl        String          // YouTube/Vimeo URL
  thumbnailUrl    String?
  type            VideoType       @default(YOUTUBE)
  
  // Content
  titlePt         String
  titleEn         String
  titleEs         String?
  titleFr         String?
  descriptionPt   String?
  descriptionEn   String?
  descriptionEs   String?
  descriptionFr   String?
  
  // Category
  category        VideoCategory   @default(INSTITUTIONAL)
  section         VideoSection    @default(VANCOUVER) // Vancouver, Courses, Workshops, Corporate
  school          String?         // VFS, VanArts, Azimut
  
  // Metadata
  duration        Int?            // seconds
  views           Int             @default(0)
  featured        Boolean         @default(false)
  priority        Int             @default(0)
  status          VideoStatus     @default(PUBLISHED)
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  @@index([category])
  @@index([section])
  @@index([school])
  @@index([featured])
  @@index([priority])
  @@index([status])
}

enum VideoType {
  YOUTUBE
  VIMEO
  MP4
}

enum VideoCategory {
  INSTITUTIONAL
  TESTIMONIAL
  STUDENT_WORK
  PROMO
  TUTORIAL
  EVENT
}

enum VideoSection {
  VANCOUVER
  COURSES
  WORKSHOPS
  CORPORATE
  HOME
}

enum VideoStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

// ════════════════════════════════════════════════════════════
// WEBINARS
// ════════════════════════════════════════════════════════════

model Webinar {
  id                String        @id @default(uuid())
  
  // Content
  titlePt           String
  titleEn           String
  titleEs           String?
  titleFr           String?
  descriptionPt     String?
  descriptionEn     String?
  descriptionEs     String?
  descriptionFr     String?
  
  // Schedule
  scheduledAt       DateTime
  duration          Int           // minutes
  timezone          String        @default("America/Sao_Paulo")
  
  // Platform
  platform          String        // Zoom, Google Meet, YouTube Live
  meetingUrl        String?       // URL da reunião
  recordingUrl      String?       // URL da gravação (depois do evento)
  
  // Target
  targetAudience    String[]      // students, corporate, schools, general
  language          String        @default("pt")
  
  // Registration
  registrations     WebinarRegistration[]
  maxParticipants   Int?
  requiresApproval  Boolean       @default(false)
  
  // Metadata
  status            WebinarStatus @default(SCHEDULED)
  featured          Boolean       @default(false)
  thumbnailUrl      String?
  
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  
  @@index([scheduledAt])
  @@index([status])
  @@index([featured])
}

model WebinarRegistration {
  id          String   @id @default(uuid())
  webinarId   String
  
  // User Info
  name        String
  email       String
  phone       String?
  company     String?
  
  // Metadata
  status      String   @default("CONFIRMED") // CONFIRMED, CANCELLED, ATTENDED, NO_SHOW
  registeredAt DateTime @default(now())
  attendedAt  DateTime?
  
  webinar     Webinar  @relation(fields: [webinarId], references: [id], onDelete: Cascade)
  
  @@index([webinarId])
  @@index([email])
  @@index([status])
}

enum WebinarStatus {
  SCHEDULED
  LIVE
  COMPLETED
  CANCELLED
}

// ════════════════════════════════════════════════════════════
// AI MEDIA ANALYSIS
// ════════════════════════════════════════════════════════════

model MediaAnalysis {
  id        String   @id @default(uuid())
  mediaId   String   @unique
  analysis  Json     // Armazena o JSON completo da análise
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  media     Media    @relation(fields: [mediaId], references: [id], onDelete: Cascade)
  
  @@index([mediaId])
}

// ════════════════════════════════════════════════════════════
// ANALYTICS & VISITOR TRACKING
// ════════════════════════════════════════════════════════════

model PWAInstall {
  id          String   @id @default(uuid())
  sessionId   String
  type        String   // 'installed' | 'prompt_shown' | 'prompt_dismissed' | 'prompt_accepted'
  platform    String?  // Win32, Linux x86_64, iPhone, etc
  userAgent   String?
  browser     String?  // Chrome, Safari, Firefox, etc
  deviceType  String?  // mobile, desktop, tablet
  outcome     String?  // 'accepted' | 'dismissed'
  country     String?
  city        String?
  createdAt   DateTime @default(now())
  
  session     VisitorSession @relation(fields: [sessionId], references: [sessionId], onDelete: Cascade)
  
  @@index([sessionId])
  @@index([type])
  @@index([country])
  @@index([createdAt])
}

model VisitorBehavior {
  id              String   @id @default(uuid())
  sessionId       String
  behaviorType    String   // 'page_view' | 'click' | 'scroll' | 'hover' | 'form_start' | 'form_abandon' | 'video_play' | 'download' | 'share' | 'search' | 'filter' | 'pwa_install' | 'cta_click' | 'external_link'
  element         String?  // ID ou classe do elemento interagido
  elementType     String?  // 'button' | 'link' | 'image' | 'video' | 'form' | etc
  pageSlug        String?  // Página onde aconteceu
  value           String?  // Valor (ex: termo de busca, filtro selecionado)
  metadata        Json?    // Dados extras (coordenadas, tempo, etc)
  timestamp       DateTime @default(now())
  
  session         VisitorSession @relation(fields: [sessionId], references: [sessionId], onDelete: Cascade)
  
  @@index([sessionId])
  @@index([behaviorType])
  @@index([pageSlug])
  @@index([timestamp])
}
